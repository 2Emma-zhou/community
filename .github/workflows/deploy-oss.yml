name: Deploy to OSS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build Docusaurus
        run: npm run build
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install OSS2
        run: pip install oss2
        
      - name: Upload to OSS
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
          OSS_REGION: ${{ secrets.OSS_REGION }}
        run: |
          python3 << 'EOF'
          import oss2
          import os
          
          # Debug info
          print("OSS_ACCESS_KEY_ID:", '${{ secrets.OSS_ACCESS_KEY_ID }}'[:10] + "...")
          print("OSS_BUCKET:", '${{ secrets.OSS_BUCKET }}')
          print("OSS_REGION:", '${{ secrets.OSS_REGION }}')
          
          auth = oss2.Auth('${{ secrets.OSS_ACCESS_KEY_ID }}', '${{ secrets.OSS_ACCESS_KEY_SECRET }}')
          
          # Construct endpoint properly: bucket.region.aliyuncs.com
          endpoint = '${{ secrets.OSS_REGION }}.aliyuncs.com'
          bucket_name = '${{ secrets.OSS_BUCKET }}'
          
          bucket = oss2.Bucket(auth, 'https://' + endpoint, bucket_name)
          
          # Check if bucket exists and is accessible
          try:
              bucket.get_bucket_info()
              print("Bucket connected successfully!")
          except Exception as e:
              print(f"Bucket connection error: {e}")
              
          # Upload all files from build directory
          for root, dirs, files in os.walk('./build'):
              for file in files:
                  file_path = os.path.join(root, file)
                  oss_path = file_path.replace('./build/', '').replace('\\', '/').lstrip('/')
                  print(f'Uploading {file_path} to /{oss_path}')
                  bucket.put_object_from_file(oss_path, file_path)
          print('All files uploaded!')
          EOF
